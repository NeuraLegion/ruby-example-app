name: ci

on:
  push:
    branches:
      - main
  pull_request:

jobs:
  test:
    runs-on: ubuntu-latest
    services:
      postgres:
        image: postgres:9.6
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: blog_development
        ports:
          - 5432:5432
        options: >-
          --health-cmd "pg_isready -U postgres"
          --health-interval 5s
          --health-timeout 5s
          --health-retries 10
    env:
      PGHOST: localhost
      PGPORT: 5432
      PGUSER: postgres
      PGPASSWORD: postgres
      PGDATABASE: blog_development
      DATABASE_URL: postgres://postgres:postgres@localhost:5432/blog_development
    steps:
      - uses: actions/checkout@v4

      - uses: ruby/setup-ruby@v1
        with:
          ruby-version: "2.3.3"

      - name: Install system deps
        run: |
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends \
            build-essential \
            libpq-dev \
            libxml2-dev \
            libxslt1-dev \
            nodejs \
            zlib1g-dev

      - name: Install bundler
        run: gem install bundler -v 1.10.6

      - name: Configure bundler for nokogiri
        run: bundle config build.nokogiri --use-system-libraries

      - name: Install gems
        run: bundle install

      - name: Wait for postgres
        run: |
          for i in $(seq 1 30); do
            bundle exec ruby -e "require 'pg'; PG.connect(host: ENV['PGHOST'], port: ENV['PGPORT'].to_i, dbname: ENV['PGDATABASE'], user: ENV['PGUSER'], password: ENV['PGPASSWORD']);" && exit 0
            sleep 2
          done
          exit 1

      - name: Setup database
        run: bundle exec rake db:create db:migrate db:seed

      - name: Start server
        run: |
          bundle exec rails server -b 0.0.0.0 -p 3000 >rails.log 2>&1 &

      - name: Wait for server readiness
        run: |
          READY=0
          for i in $(seq 1 30); do
            echo "Attempt ${i}/30: checking http://localhost:3000"
            if curl -sSfL http://localhost:3000 >/dev/null; then
              echo "Server responded successfully on attempt ${i}."
              READY=1
              break
            fi
            echo "Server still starting up, waiting 2s before retry."
            sleep 2
          done
          if [ "$READY" -ne 1 ]; then
            echo "Server failed to start"
            tail -n 200 rails.log || true
            exit 1
          fi
          echo "Server is ready; last 200 lines of rails.log:"
          tail -n 200 rails.log || true

      - name: Check homepage
        run: |
          if ! curl -sSfL http://localhost:3000 | grep -F "Home"; then
            echo "Homepage check failed"
            exit 1
          fi